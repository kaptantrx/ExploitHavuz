import requests
from bs4 import BeautifulSoup
import pymongo


class Rapid7:
    def __init__(self):
        self.myClient = pymongo.MongoClient("mongodb://localhost:27017/") 
        self.myDb =  self.myClient["THT"] 
        self.myCollection =  self.myDb["RAPID7"]
        self.arrayUrls = []
        self.arrayTitles = []
        self.arrayDateTime = []

    def scrapingRapid(self,URL):
        page = requests.get(URL)
        soup = BeautifulSoup(page.content, "html.parser")

        urls = soup.findAll("a", {"class": "vulndb__result resultblock"},href=True)
        for url in urls:
            self.arrayUrls.append(url['href'].strip())

        titles = soup.findAll("div", {"class": "resultblock__info-title"})
        for title in titles:
            self.arrayTitles.append(title.text.strip())

        datetimes = soup.findAll("div", {"class": "resultblock__info-meta"})
        for item in datetimes:
            self.arrayDateTime.append(item.text.strip().replace(" ","").replace("\n",""))  

        sayac = 0
        while sayac<len(self.arrayDateTime):
            myExploit = {  
                "Url": "https://www.rapid7.com/"+self.arrayUrls[sayac], 
                "Title": self.arrayTitles[sayac], 
                "DateTime": self.arrayDateTime[sayac]
            }

            queryTitle = {"Title":self.arrayTitles[sayac]}
            
            if self.myCollection.find_one(queryTitle) == None:
                self.myCollection.insert_one(myExploit)

            sayac = sayac +1
    
    def arrayClear(self):
        self.arrayUrls.clear()
        self.arrayTitles.clear()
        self.arrayDateTime.clear()


if __name__ == '__main__':
    
    Script = Rapid7()
    print("Rapid Exploit Bilgileri Çekiliyor.")
    Script.scrapingRapid("https://www.rapid7.com/db/")
    Script.arrayClear()
    Script.scrapingRapid("https://www.rapid7.com/db/?q=&type=&page=2")
    Script.arrayClear()
    Script.scrapingRapid("https://www.rapid7.com/db/?q=&type=&page=3")
    print("İşlem Tamamlandı.")